<!DOCTYPE html>
<html lang="en">
<%-include('../layouts/header')-%>
    <style>
        /* Dashboard full-width layout */
        .admin-dashboard {
            width: 100%;
            max-width: none;
            padding-left: 12px;
            padding-right: 12px;
        }

        .admin-dashboard .card {
            width: 100%;
            max-width: none;
        }

        .dashboard-table {
            width: 100% !important;
        }

        .dashboard-table th,
        .dashboard-table td {
            white-space: normal !important;
        }
    </style>

    <body>
        <!-- Google Tag Manager (noscript) -->
        <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WPZ6BNP4" height="0" width="0"
                style="display:none;visibility:hidden"></iframe></noscript>
        <!-- End Google Tag Manager (noscript) -->
        <!-- Navigation-->
        <%-include('../layouts/navbar')-%>

            <!-- Page Header-->
            <header class="masthead">
                <div class="container position-relative px-4 px-lg-5">
                    <div class="row gx-4 gx-lg-5 justify-content-center">
                        <div class="col-md-10 col-lg-8 col-xl-7">
                            <div class="page-heading">
                                <h1>Admin Dashboard</h1>
                                <span class="subheading">Manage your blog content</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content-->
            <main class="mb-4 admin-dashboard">
                <div class="container-fluid px-2">
                    <div class="row">
                        <div class="col-12">
                            <!-- Success/Error Messages -->
                            <% if (typeof success !=='undefined' && success) { %>
                                <div class="alert alert-success" role="alert">
                                    <%= success %>
                                </div>
                                <% } %>

                                    <!-- Dashboard Stats -->
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h2 class="card-title text-primary">
                                                        <%= totalPosts %>
                                                    </h2>
                                                    <p class="card-text">Total Posts</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h2 class="card-title text-info">
                                                        <%= totalUsers %>
                                                    </h2>
                                                    <p class="card-text">Total Users</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Quick Actions -->
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <h3>Quick Actions</h3>
                                        </div>
                                        <div class="card-body">
                                            <a href="/posts/new" class="btn btn-primary me-2 mb-2">Create New Post</a>
                                            <a href="/admin/posts" class="btn btn-secondary me-2 mb-2">Manage All
                                                Posts</a>
                                            <a href="/admin/categories" class="btn btn-warning me-2 mb-2">Manage
                                                Categories</a>
                                            <a href="/admin/contact-messages" class="btn btn-success me-2 mb-2">Contact
                                                Messages</a>
                                            <a href="/admin/users" class="btn btn-info mb-2">Manage Users</a>
                                        </div>
                                    </div>

                                    <!-- Recent Posts -->
                                    <div class="card">
                                        <div class="card-header">
                                            <h3>Recent Exercises</h3>
                                        </div>
                                        <div class="card-body p-4 bg-light" id="filters">
                                                 <%
                                            var selectedParent = null;
                                            var defaultCategory = 'Algèbre';
                                            var activeCategory = category || defaultCategory;
                                            var algebre = null;
                                            var analyse = null;
                                            var children = [];
                                            
                                            for (var i = 0; i < categories.length; i++) {
                                                if (categories[i].name === 'Algèbre' && !categories[i].parent) {
                                                    algebre = categories[i];
                                                }
                                                if (categories[i].name === 'Analyse' && !categories[i].parent) {
                                                    analyse = categories[i];
                                                }
                                            }
                                            
                                            if (activeCategory === 'Algèbre') {
                                                selectedParent = algebre;
                                            } else if (activeCategory === 'Analyse') {
                                                selectedParent = analyse;
                                            } else {
                                                for (var i = 0; i < categories.length; i++) {
                                                    if (!categories[i].parent) {
                                                        for (var j = 0; j < categories.length; j++) {
                                                            if (categories[j].parent && 
                                                                categories[j].parent.toString() === categories[i]._id.toString() && 
                                                                categories[j].name === activeCategory) {
                                                                selectedParent = categories[i];
                                                                break;
                                                            }
                                                        }
                                                        if (selectedParent) break;
                                                    }
                                                }
                                            }
                                            
                                            if (!selectedParent) {
                                                selectedParent = algebre;
                                            }
                                            
                                            if (selectedParent) {
                                                for (var i = 0; i < categories.length; i++) {
                                                    if (categories[i].parent && 
                                                        categories[i].parent.toString() === selectedParent._id.toString()) {
                                                        children.push(categories[i]);
                                                    }
                                                }
                                            }
                                            %>
                                            
                                            <h5 class="text-center mb-3 text-muted">Filtrer par catégorie</h5>
                                            
                                            <div class="d-flex gap-3 justify-content-center mb-3">
                                                <a href="/admin/dashboard?category=Algèbre#filters"
                                                   class="btn btn-lg <%= selectedParent && selectedParent.name === 'Algèbre' ? 'btn-primary' : 'btn-outline-primary' %>"
                                                   style="min-width: 150px; font-weight: 700;">
                                                    ALGÈBRE                                                    </a>
                                                <a href="/admin/dashboard?category=Analyse#filters"
                                                   class="btn btn-lg <%= selectedParent && selectedParent.name === 'Analyse' ? 'btn-success' : 'btn-outline-success' %>"
                                                   style="min-width: 150px; font-weight: 700;">
                                                    ANALYSE
                                                </a>
                                            </div>

                                                <% if (children && children.length> 0) { %>
                                                    <div class="d-flex flex-wrap gap-2 justify-content-center">
                                                        <% for (var i=0; i < children.length; i++) { %>
                                                            <a href="/admin/dashboard?category=<%= children[i].name %>#filters"
                                                                class="btn btn-sm <%= activeCategory === children[i].name ? 'btn-secondary' : 'btn-outline-secondary' %>">
                                                                <%= children[i].name %>
                                                            </a>
                                                            <% } %>
                                                    </div>
                                                    <% } %>
                                                        <div class="card-body">
                                                            <% if (recentPosts.length> 0) { %>
                                                                <div class="table-responsive"
                                                                    style="overflow-x: visible;">
                                                                    <table class="table table-striped dashboard-table">
                                                                        <thead>
                                                                            <tr>
                                                                                <th style="width: 20%;">Title</th>
                                                                                <th style="width: 15%;">Author</th>
                                                                                <th style="width: 10%;">Status</th>
                                                                                <th style="width: 15%;">Created</th>
                                                                                <th style="width: 40%;">Actions</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            <% recentPosts.forEach(post=> { %>
                                                                                <tr
                                                                                    class="<%= post.isDeleted ? 'table-secondary' : '' %>">
                                                                                    <td>
                                                                                        <% if (!post.isDeleted) { %>
                                                                                            <a
                                                                                                href="/post/<%= post._id %>">
                                                                                                <%= post.title %>
                                                                                            </a>
                                                                                            <% } else { %>
                                                                                                <span
                                                                                                    class="text-muted">
                                                                                                    <%= post.title %>
                                                                                                        (Deleted)
                                                                                                </span>
                                                                                                <% } %>
                                                                                    </td>
                                                                                    <td>
                                                                                        <% if (post.author &&
                                                                                            post.author.username) { %>
                                                                                            <%= post.author.username %>
                                                                                                <% } else { %>
                                                                                                    <span
                                                                                                        class="text-muted">Unknown</span>
                                                                                                    <% } %>
                                                                                    </td>
                                                                                    <td>
                                                                                        <% if (post.isDeleted) { %>
                                                                                            <span
                                                                                                class="badge bg-danger">Deleted</span>
                                                                                            <% } else { %>
                                                                                                <span
                                                                                                    class="badge bg-success">Published</span>
                                                                                                <% } %>
                                                                                    </td>
                                                                                    <td>
                                                                                        <%= new
                                                                                            Date(post.createdAt).toLocaleDateString()
                                                                                            %>
                                                                                    </td>
                                                                                    <td>
                                                                                        <div
                                                                                            class="d-flex align-items-center gap-1">
                                                                                            <% if (!post.isDeleted) { %>
                                                                                                <a href="/admin/posts/<%= post._id %>/edit"
                                                                                                    class="btn btn-sm btn-outline-primary"
                                                                                                    style="height: 31px; line-height: 1.5; display: flex; align-items: center;">Edit</a>
                                                                                                <% if (!post.solutionId)
                                                                                                    { %>
                                                                                                    <a href="/posts/new?exerciseId=<%= post._id %>"
                                                                                                        class="btn btn-sm btn-outline-success"
                                                                                                        style="height: 31px; line-height: 1.5; display: flex; align-items: center;">Write
                                                                                                        Solution</a>
                                                                                                    <% } else { %>
                                                                                                        <a href="/admin/posts/<%= post.solutionId._id || post.solutionId %>/edit"
                                                                                                            class="btn btn-sm btn-outline-info"
                                                                                                            style="height: 31px; line-height: 1.5; display: flex; align-items: center;">Edit
                                                                                                            Solution</a>
                                                                                                        <% } %>
                                                                                                            <form
                                                                                                                action="/admin/posts/<%= post._id %>/delete"
                                                                                                                method="post"
                                                                                                                class="d-inline"
                                                                                                                style="margin: 0;">
                                                                                                                <button
                                                                                                                    type="submit"
                                                                                                                    class="btn btn-sm btn-outline-danger"
                                                                                                                    style="height: 31px; line-height: 1.5; display: flex; align-items: center;"
                                                                                                                    onclick="return confirm('Are you sure you want to delete this post?')">
                                                                                                                    Delete
                                                                                                                </button>
                                                                                                            </form>
                                                                                                            <% } else {
                                                                                                                %>
                                                                                                                <form
                                                                                                                    action="/admin/posts/<%= post._id %>/restore"
                                                                                                                    method="post"
                                                                                                                    class="d-inline"
                                                                                                                    style="margin: 0;">
                                                                                                                    <button
                                                                                                                        type="submit"
                                                                                                                        class="btn btn-sm btn-outline-success"
                                                                                                                        style="height: 31px; line-height: 1.5; display: flex; align-items: center;">
                                                                                                                        Restore
                                                                                                                    </button>
                                                                                                                </form>
                                                                                                                <% } %>
                                                                                        </div>
                                                                                    </td>
                                                                                </tr>
                                                                                <% }); %>
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                                <% } else { %>
                                                                    <p class="text-muted">No exercises found.</p>
                                                                    <% } %>

                                                                        <div class="mt-3">
                                                                            <a href="/admin/posts"
                                                                                class="btn btn-outline-secondary">View
                                                                                All Posts</a>
                                                                        </div>
                                                        </div>
                                        </div>
                                    </div>
                        </div>
                    </div>
            </main>

            <!-- Footer-->
            <%-include('../layouts/footer')-%>
    </body>

</html>