<!DOCTYPE html>
<html lang="en">
<%- include('layouts/header') -%>
    <!-- reCAPTCHA v3 Script -->
    <script src="https://www.google.com/recaptcha/api.js?render=<%= recaptchaSiteKey %>" async defer></script>

    <body>
        <!-- Google Tag Manager (noscript) -->
        <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WPZ6BNP4" height="0" width="0"
                style="display:none;visibility:hidden"></iframe></noscript>
        <!-- End Google Tag Manager (noscript) -->

        <%- include('layouts/navbar') -%>

            <header class="masthead">
                <div class="container position-relative px-4 px-lg-5">
                    <div class="row gx-4 gx-lg-5 justify-content-center">
                        <div class="col-md-10 col-lg-8 col-xl-7">
                            <div class="page-heading">
                                <h1>Register</h1>
                                <span class="subheading">Create a new account</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <main class="mb-4">
                <div class="container px-4 px-lg-5">
                    <div class="row gx-4 gx-lg-5 justify-content-center">
                        <div class="col-md-10 col-lg-8 col-xl-7">
                            <% if (typeof error !=='undefined' && error) { %>
                                <div class="alert alert-danger" role="alert">
                                    <%= error %>
                                </div>
                                <% } %>

                                    <p>Create a new account</p>

                                    <div class="my-5">
                                        <form action="/users/register" method="post">
                                            <div class="control-group">
                                                <div class="form-group floating-label-form-group controls">
                                                    <label>Username</label>
                                                    <input class="form-control" id="username" name="username"
                                                        type="text" placeholder="Enter username" required minlength="3">
                                                    <p class="help-block text-danger"></p>
                                                </div>
                                            </div>

                                            <div class="control-group">
                                                <div class="form-group floating-label-form-group controls">
                                                    <label>Password</label>
                                                    <div style="position: relative;">
                                                        <input class="form-control" id="password" name="password"
                                                            type="password" placeholder="Password (min 6 characters)"
                                                            required minlength="6">
                                                        <button type="button" class="togglePassword"
                                                            data-target="password"
                                                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: transparent; cursor: pointer; font-size: 1.2em; padding: 5px 10px;">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </div>
                                                    <p class="help-block text-danger"></p>
                                                </div>
                                            </div>

                                            <div class="control-group">
                                                <div class="form-group floating-label-form-group controls">
                                                    <label>Confirm Password</label>
                                                    <div style="position: relative;">
                                                        <input class="form-control" id="confirmPassword"
                                                            name="confirmPassword" type="password"
                                                            placeholder="Confirm Password" required minlength="6">
                                                        <button type="button" class="togglePassword"
                                                            data-target="confirmPassword"
                                                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: transparent; cursor: pointer; font-size: 1.2em; padding: 5px 10px;">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </div>
                                                    <p class="help-block text-danger"></p>
                                                </div>
                                            </div>

                                            <!-- reCAPTCHA v3 is invisible, no widget needed -->
                                            <input type="hidden" id="g-recaptcha-response" name="g-recaptcha-response">

                                            <br>
                                            <button type="submit"
                                                class="btn btn-primary text-uppercase">Register</button>
                                        </form>
                                    </div>

                                    <div class="text-center mt-3">
                                        <p>Already have an account? <a href="/users/login">Login</a></p>
                                    </div>
                        </div>
                    </div>
                </div>
            </main>

            <%- include('layouts/footer') -%>

                <script>
                    // Toggle password visibility for all password fields
                    document.querySelectorAll('.togglePassword').forEach(button => {
                        button.addEventListener('click', function () {
                            const targetId = this.getAttribute('data-target');
                            const passwordInput = document.getElementById(targetId);
                            const eyeIcon = this.querySelector('i');

                            if (passwordInput.type === 'password') {
                                passwordInput.type = 'text';
                                eyeIcon.classList.remove('fa-eye');
                                eyeIcon.classList.add('fa-eye-slash');
                            } else {
                                passwordInput.type = 'password';
                                eyeIcon.classList.remove('fa-eye-slash');
                                eyeIcon.classList.add('fa-eye');
                            }
                        });
                    });

                    // reCAPTCHA v3 - Execute on form submit
                    const registerForm = document.querySelector('form[action="/users/register"]');
                    if (registerForm) {
                        registerForm.addEventListener('submit', function (e) {
                            e.preventDefault();
                            const siteKey = '<%= recaptchaSiteKey %>';
                            if (siteKey && typeof grecaptcha !== 'undefined') {
                                grecaptcha.ready(function () {
                                    grecaptcha.execute(siteKey, { action: 'register' }).then(function (token) {
                                        document.getElementById('g-recaptcha-response').value = token;
                                        registerForm.submit();
                                    });
                                });
                            } else {
                                registerForm.submit();
                            }
                        });
                    }
                </script>
    </body>

</html>